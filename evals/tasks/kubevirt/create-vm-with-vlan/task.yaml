kind: Task
apiVersion: mcpchecker/v1alpha2
metadata:
  name: "create-vm-with-vlan"
  difficulty: hard
spec:
  requires:
    - extension: kubernetes
      as: k8s
  setup:
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
    - k8s.create:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
    - k8s.create:
        apiVersion: k8s.cni.cncf.io/v1
        kind: NetworkAttachmentDefinition
        metadata:
          name: vlan-network
          namespace: vm-test
        spec:
          config: '{"bridge":"br10","cniVersion":"0.3.1","ipam":null,"macspoofchk":false,"mtu":1400,"name":"linux-bridge-net-vlan100","type":"bridge","vlan":100}'
  verify:
    - script:
        inline: |-
          #!/usr/bin/env bash
          source ../helpers/verify-vm.sh
          NS="vm-test"

          verify_vm_exists "test-vm" "$NS" || exit 1
          verify_container_disk "test-vm" "$NS" "fedora" || exit 1
          verify_run_strategy "test-vm" "$NS" || exit 1
          verify_no_deprecated_running_field "test-vm" "$NS" || exit 1
          verify_multus_secondary_network "test-vm" "$NS" "vlan-network" || exit 1

          echo "All validations passed"
          exit 0
  cleanup:
    - k8s.delete:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: test-vm
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: k8s.cni.cncf.io/v1
        kind: NetworkAttachmentDefinition
        metadata:
          name: vlan-network
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
  prompt:
    inline: Please create a Fedora virtual machine named test-vm in the vm-test namespace with a secondary network interface connected to the vlan-network multus network.
