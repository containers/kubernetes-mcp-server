kind: Task
apiVersion: mcpchecker/v1alpha2
metadata:
  name: "restore-vm"
  difficulty: medium
spec:
  requires:
    - extension: kubernetes
      as: k8s
  setup:
    # Enable Snapshot feature gate - requires kubectl patch (no extension op available)
    - script:
        inline: |-
          #!/usr/bin/env bash
          set -e
          echo "Enabling Snapshot feature gate in KubeVirt CR..."
          KUBEVIRT_CR=$(kubectl get kubevirt -A -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          KUBEVIRT_NS=$(kubectl get kubevirt -A -o jsonpath='{.items[0].metadata.namespace}' 2>/dev/null || echo "")
          kubectl patch kubevirt "$KUBEVIRT_CR" -n "$KUBEVIRT_NS" --type=merge -p '{"spec":{"configuration":{"developerConfiguration":{"featureGates":["Snapshot"]}}}}'
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
    - k8s.create:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
    - k8s.create:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: restore-test-vm
          namespace: vm-test
        spec:
          runStrategy: Always
          template:
            spec:
              domain:
                devices: {}
                memory:
                  guest: 512Mi
                resources: {}
              terminationGracePeriodSeconds: 180
    - k8s.create:
        apiVersion: snapshot.kubevirt.io/v1beta1
        kind: VirtualMachineSnapshot
        metadata:
          name: restore-snapshot
          namespace: vm-test
        spec:
          source:
            apiGroup: kubevirt.io
            kind: VirtualMachine
            name: restore-test-vm
    - k8s.wait:
        apiVersion: snapshot.kubevirt.io/v1beta1
        kind: VirtualMachineSnapshot
        metadata:
          name: restore-snapshot
          namespace: vm-test
        condition: Ready
        timeout: 30s
  verify:
    - script:
        inline: |-
          #!/usr/bin/env bash
          set -e
          NS="vm-test"
          RESTORE_NAME="test-restore"

          # Verify restore was created
          if ! kubectl get virtualmachinerestore "$RESTORE_NAME" -n "$NS" &>/dev/null; then
            echo "ERROR: VirtualMachineRestore '$RESTORE_NAME' not found"
            exit 1
          fi

          # Verify restore target VM
          TARGET_NAME=$(kubectl get virtualmachinerestore "$RESTORE_NAME" -n "$NS" -o jsonpath='{.spec.target.name}')
          if [ "$TARGET_NAME" != "restored-vm" ]; then
            echo "ERROR: Restore target is '$TARGET_NAME', expected 'restored-vm'"
            exit 1
          fi

          # Verify restore used correct snapshot
          SNAPSHOT_NAME=$(kubectl get virtualmachinerestore "$RESTORE_NAME" -n "$NS" -o jsonpath='{.spec.virtualMachineSnapshotName}')
          if [ "$SNAPSHOT_NAME" != "restore-snapshot" ]; then
            echo "ERROR: Restore snapshot is '$SNAPSHOT_NAME', expected 'restore-snapshot'"
            exit 1
          fi

          echo "All restore validations passed"
          exit 0
  cleanup:
    - k8s.delete:
        apiVersion: snapshot.kubevirt.io/v1beta1
        kind: VirtualMachineRestore
        metadata:
          name: test-restore
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: snapshot.kubevirt.io/v1beta1
        kind: VirtualMachineSnapshot
        metadata:
          name: restore-snapshot
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: restore-test-vm
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: restored-vm
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
  prompt:
    inline: |
      Restore the snapshot named restore-snapshot in the vm-test namespace to a new virtual machine named restored-vm. Use the restore name test-restore.
