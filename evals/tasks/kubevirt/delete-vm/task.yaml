kind: Task
apiVersion: mcpchecker/v1alpha2
metadata:
  name: "delete-vm"
  difficulty: medium
spec:
  requires:
    - extension: kubernetes
      as: k8s
  setup:
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
    - k8s.create:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
    - k8s.create:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: deleted-vm
          namespace: vm-test
        spec:
          runStrategy: Always
          template:
            spec:
              domain:
                devices:
                  disks:
                    - name: containerdisk
                      disk:
                        bus: virtio
                resources:
                  requests:
                    memory: 2Gi
              terminationGracePeriodSeconds: 0
              volumes:
                - name: containerdisk
                  containerDisk:
                    image: quay.io/containerdisks/opensuse-leap:15.6
    - k8s.wait:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: deleted-vm
          namespace: vm-test
        condition: Ready
        timeout: 30s
  verify:
    # kubectl wait --for=delete is not a condition-based wait,
    # so it must remain as a script step
    - script:
        inline: |-
          #!/usr/bin/env bash
          kubectl wait --for=delete vm/deleted-vm -n vm-test --timeout 30s || exit 1
  cleanup:
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
  prompt:
    inline: |
      Please delete the virtual machine named deleted-vm in the vm-test namespace.
