kind: Task
apiVersion: mcpchecker/v1alpha2
metadata:
  name: "snapshot-vm"
  difficulty: medium
spec:
  requires:
    - extension: kubernetes
      as: k8s
  setup:
    # Enable Snapshot feature gate - requires kubectl patch (no extension op available)
    - script:
        inline: |-
          #!/usr/bin/env bash
          set -e
          echo "Enabling Snapshot feature gate in KubeVirt CR..."
          KUBEVIRT_CR=$(kubectl get kubevirt -A -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          KUBEVIRT_NS=$(kubectl get kubevirt -A -o jsonpath='{.items[0].metadata.namespace}' 2>/dev/null || echo "")
          kubectl patch kubevirt "$KUBEVIRT_CR" -n "$KUBEVIRT_NS" --type=merge -p '{"spec":{"configuration":{"developerConfiguration":{"featureGates":["Snapshot"]}}}}'
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
    - k8s.create:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
    - k8s.create:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: snapshot-test-vm
          namespace: vm-test
        spec:
          runStrategy: Always
          template:
            spec:
              domain:
                devices: {}
                memory:
                  guest: 512Mi
                resources: {}
              terminationGracePeriodSeconds: 180
  verify:
    - script:
        inline: |-
          #!/usr/bin/env bash
          set -e
          NS="vm-test"
          SNAPSHOT_NAME="test-snapshot"

          # Verify snapshot was created
          if ! kubectl get virtualmachinesnapshot "$SNAPSHOT_NAME" -n "$NS" &>/dev/null; then
            echo "ERROR: VirtualMachineSnapshot '$SNAPSHOT_NAME' not found"
            exit 1
          fi

          # Verify snapshot is for the correct VM
          SOURCE_NAME=$(kubectl get virtualmachinesnapshot "$SNAPSHOT_NAME" -n "$NS" -o jsonpath='{.spec.source.name}')
          if [ "$SOURCE_NAME" != "snapshot-test-vm" ]; then
            echo "ERROR: Snapshot source is '$SOURCE_NAME', expected 'snapshot-test-vm'"
            exit 1
          fi

          echo "All snapshot validations passed"
          exit 0
  cleanup:
    - k8s.delete:
        apiVersion: snapshot.kubevirt.io/v1beta1
        kind: VirtualMachineSnapshot
        metadata:
          name: test-snapshot
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: snapshot-test-vm
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
  prompt:
    inline: |
      Create a snapshot named test-snapshot of the virtual machine snapshot-test-vm in the vm-test namespace.
