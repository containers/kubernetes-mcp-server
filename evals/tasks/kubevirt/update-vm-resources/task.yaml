kind: Task
apiVersion: mcpchecker/v1alpha2
metadata:
  labels:
    suite: kubevirt
    requires: kubevirt
  name: "update-vm-resources"
  difficulty: hard
spec:
  requires:
    - extension: kubernetes
      as: k8s
  setup:
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
    - k8s.create:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
    - k8s.create:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: test-vm-update
          namespace: vm-test
        spec:
          runStrategy: Halted
          template:
            spec:
              domain:
                cpu:
                  cores: 1
                memory:
                  guest: 2Gi
                devices:
                  disks:
                    - name: containerdisk
                      disk:
                        bus: virtio
              volumes:
                - name: containerdisk
                  containerDisk:
                    image: quay.io/containerdisks/opensuse-leap:15.6
  verify:
    - script:
        inline: |-
          #!/usr/bin/env bash
          source ../helpers/verify-vm.sh
          NS="vm-test"

          verify_vm_exists "test-vm-update" "$NS" || exit 1
          verify_cpu_cores "test-vm-update" "$NS" 2 || exit 1
          verify_memory_increased "test-vm-update" "$NS" "2Gi" || exit 1

          echo "All validations passed"
          exit 0
  cleanup:
    - k8s.delete:
        apiVersion: kubevirt.io/v1
        kind: VirtualMachine
        metadata:
          name: test-vm-update
          namespace: vm-test
        ignoreNotFound: true
    - k8s.delete:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: vm-test
        ignoreNotFound: true
  prompt:
    inline: |-
      A VirtualMachine named test-vm-update exists in the vm-test namespace.

      It currently has 1 vCPU and 2Gi of memory.

      Please update the VirtualMachine to add an additional vCPU (making it 2 vCPUs total) and increase the memory to at least 3Gi.
